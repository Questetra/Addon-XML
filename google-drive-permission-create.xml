<?xml version="1.0" encoding="UTF-8"?>
<service-task-definition>
<last-modified>2022-02-04</last-modified>
<license>(C) Questetra, Inc. (MIT License)</license>
<engine-type>2</engine-type>
<label>Google Drive: Create Permission</label>
<label locale="ja">Google ドライブ: 共有設定</label>
<summary>Create Permissions in the specified files and/or folders on Google Drive</summary>
<summary locale="ja">Google ドライブ の指定ファイルやフォルダを共有します</summary>
<configs>
  <config name="conf_UserID" required="true" form-type="QUSER">
    <label>C1: User who connects to Google Drive</label>
    <label locale="ja">C1: Google ドライブ に接続するユーザ</label>
  </config>
  <config name="conf_FileIdsItem" form-type="SELECT" select-data-type="STRING" required="true">
    <label>C2: File / Folder IDs to share</label>
    <label locale="ja">C2: 共有するファイル/フォルダの ID</label>
  </config>
  <config name="conf_SharedRange" form-type="SELECT_ITEM" required="true">
    <label>C3: Shared range</label>
    <label locale="ja">C3: 共有範囲</label>
    <item value="public">
      <label>Public</label>
      <label locale="ja">リンクを知っている全員</label>
    </item>
    <item value="domain">
      <label>Domain</label>
      <label locale="ja">ドメイン</label>
    </item>
  </config>
  <config name="conf_Domain" form-type="TEXTFIELD">
    <label>C4: Domain to share (required if the shared range is domain)</label>
    <label locale="ja">C4: 共有先のドメイン(共有範囲がドメインの場合は必須</label>
  </config>
  <config name="conf_AllowFileDiscovery" form-type="TOGGLE">
    <label>C5: Allow the file to be discovered through search</label>
    <label locale="ja">C5: 検索可能にする</label>
  </config>
  <config name="conf_Editable" form-type="TOGGLE">
    <label>C6: Allow the file to be edited</label>
    <label locale="ja">C6: 編集可能にする</label>
  </config>
  <config name="conf_SharedUrlItem" form-type="SELECT" select-data-type="STRING">
    <label>C7: Data Item that will save URLs of shared Files / Folders</label>
    <label locale="ja">C7: 共有したファイル/フォルダの表示 URL を保存するデータ項目</label>
  </config>
</configs>
<help-page-url>https://support.questetra.com/bpmn-icons/googledrive-permissioncreate/</help-page-url>
<help-page-url locale="ja">https://support.questetra.com/ja/bpmn-icons/googledrive-permissioncreate/</help-page-url>
  <script><![CDATA[
main();

function main() {
  const filesIdArray = getFileIds();
  const quser = getQuser();
  const sharedRange = configs.get("conf_SharedRange");
  const domain = configs.get("conf_Domain");
  if (sharedRange === "domain" && domain === ""){
    throw "Domain to share isn't set.";
  }
  const allowFileDiscovery = configs.get("conf_AllowFileDiscovery");
  const editable = configs.getObject("conf_Editable");
  const urlDataDef = configs.getObject("conf_SharedUrlItem");
  const idsNum = filesIdArray.length;
  idNumCheck(urlDataDef,idsNum)

  const sharedUrls = [];
  for (let i = 0; i < idsNum; i++) {
    sharedUrls.push(createPermission(quser, filesIdArray[i], sharedRange, domain, allowFileDiscovery, editable));
  }
  
  if (urlDataDef !== null) {
    engine.setData(urlDataDef, sharedUrls.join("\n"));
  }
}

/**
 * データ項目からファイル / フォルダ ID を取得し、配列に入れて返す
 * ID の数が通信制限を超えていればエラー
 * @return {Array<String>}  ファイル / フォルダ ID の配列
 */
function getFileIds() {
    const fileIds = engine.findData(configs.getObject("conf_FileIdsItem"));
    if (fileIds === null) {
        throw "File / Folder IDs aren't set.";
    }
    let fileIdsArray = fileIds.split("\n");
    fileIdsArray = fileIdsArray.filter(lines => lines !== ""); // 空文字列を削除
    if (fileIdsArray.length === 0) {
        throw "File / Folder IDs aren't set.";
    }
    if (fileIdsArray.length * 2 > httpClient.getRequestingLimit()) {
        //check number of files
        throw "Number of File IDs is over the limit.";
    }
    return fileIdsArray;
}

/**
  * 共有するファイル/フォルダの ID が複数で URL 出力先のデータ項目が単一行ならエラーにする
  * @param {ProcessDataDefinitionView} dataDef  データ項目の ProcessDataDefinitionView
  * @param {Number} idNum  共有しようとしているファイル/フォルダの ID の個数
  */
function idNumCheck(dataDef,idNum){
  if(dataDef !==  null){
    //Multiple Judge
    if(dataDef.matchDataType("STRING_TEXTFIELD") && idNum > 1){
      throw "Multiple ids are set though the Data Item to save the output is Single-line String."
    }
  }
}

/**
 * 実行ユーザを取得する
 * @return {QuserView} 実行ユーザ
 */
function getQuser() {
    const quser = configs.getObject("conf_UserID");
    if (quser === null) {
        throw "User not found";
    }
    engine.log(`User Name: ${quser.getName()}`);
    return quser;
}
/**
  * Google Drive 上で共有設定をする
  * create permission on Google Drive
  * @param {QuserView} quser  Google Drive に接続するユーザ
  * @param {String} fileId  ファイルの ID
  * @param {String} sharedRange  共有範囲
  * @param {String} domain  共有先ドメイン
  * @param {String} allowFileDiscovery  検索可能にするかどうか
  * @param {boolean} editable  編集可能にするかどうか
  * @return {String} 共有リンク
  */
function createPermission(quser, fileId, sharedRange, domain, allowFileDiscovery, editable) {
  const json = {};
  json["role"] = editable ? "writer" : "reader";
  json["type"] = sharedRange === "public" ? "anyone" : "domain";
  if(sharedRange === "domain"){
    json["domain"] = domain;
  }
  json["allowFileDiscovery"] = allowFileDiscovery;
  const permissionUrl = `https://www.googleapis.com/drive/v3/files/${fileId}/permissions`;
  const responsePermission = httpClient.begin()
    .googleOAuth2(quser, "Drive")
    .queryParam("supportsAllDrives", "true")
    .body(JSON.stringify(json), "application/json; charset=UTF-8")
    .post(permissionUrl);
  const status = responsePermission.getStatusCode();
  if (status >= 300) {
    engine.log(responsePermission.getResponseAsString())
    throw `Failed to create permission:${fileId}\nStatus:${status}`;
  }
  //URL 取得
  const getUrl = `https://www.googleapis.com/drive/v3/files/${fileId}`;
  const responseGet = httpClient.begin()
    .googleOAuth2(quser, "Drive")
    .queryParam("fields", "webViewLink")
    .get(getUrl);
  const resJson = JSON.parse(responseGet.getResponseAsString());
  const sharedlink = resJson["webViewLink"];
  return(sharedlink);
}
  ]]></script>

  <icon>iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADLUlEQVRYR2NkYGBgZBhAALJ81AFE
hUBmYabNj19/dglzM7ERirGerpkshNTA5ImOgvTClGu/fjEq5AfeYdeX+YrT0cv2S3y69kjgVGv7
IjdiHEGUAzKK0nKf8X9peyz5ntv5jty/7qTzTPgML51n+O/rbyaH6f3TjxByBFEOSMxO/XZB/wnH
d6k/DGpnRb82WT/nwhcKF59w/5++VfnmzP45WhQ7IL0wdfZzga8Rt4xfc4MM43zGwkBMKICi4vBt
idoZfbMm43ME3hAAJbx/DL9nHXR+qAEzBOQA2eeCBEMBpD5psv6P+VNnc5HtgOrKuF2XOf5YwnyP
7oiN4XfAoYILEJMgcYYAyPdPBT5uR7ccFg2gUAgX+/I3yvEFHyUJEqcDQNnulOZTDVDCQwegaAAB
g4syPwhlS1CCXL1Xdi+ubInVAbBsh833yNEAcgAb2/8HM9IvwdMIttDAlyAxHIAt4WEzFJQdJT9w
rwDJ2am9DMUXFfiyJYYD0LMdNstBUQDyPSyFg8qJebkXOQglyEO3xFfP7J+diqwOxQGk+F7qI08V
LI+DosxW9UUzoQQJypYcbCxuyCUkigPwJTzkuDe7Ln0DvZQD6c30vqtOqIRET5BwBxCT8ECOsN8r
f4OJgTUNvZyHhR6pCRLuAOTyHldcwhIeejzC1IPSDyhBBuvu42MXwV4NoGdLsAOISXj4fA9zACwU
JgavwJktQQ4DZUtYgoQ6AHehAzMc5HvhV9zM/xkl/uFL7SA5xv8vmAg1XD7//nsLlI7ADiAm/i23
K/y48ywQnNXY9S0ZePlx1zGfP37D60aZN33fONheVoJyETwN4MsBIN+/vxADrngIWU4odDjeH/vP
93kpvK0AdwCszXfc8wFKgQKyXOi1MuPdp5ZclFoOchz/3ZZvnKxvPGC5CK0cwGx8gEo8UNBTw3KI
75fNQ85FGEUxLDvCajtqWQ5KF8ofSzEKMAwHwBIkyAGgoH8iUsSFL8ERinOYPCjoYQkPZ12AKFBS
rj0X+Cb77f9UbmpYjp7wCDoAlCC//xbZQazviFGHnPAIOoAYA6mlhqh+AbUsw2bOgDsAAHEO2FDM
6/Q2AAAAAElFTkSuQmCC</icon>


<test><![CDATA[


const DOMAIN = 'domain';
const PUBLIC = 'public';

/**
 * 設定の準備
 * @param fileIds
 * @param sharedRange
 * @param domain
 * @param allowFileDiscovery
 * @param editable
 * @return sharedUrlItemDef
 */
const prepareConfigs = (fileIds, sharedRange, domain, allowFileDiscovery, editable) => {
  const quser = engine.createQuser(3, 'サウスポール', 'SouthPole@questetra.com');
  configs.putObject('conf_UserID', quser);
  
  // 共有するファイル/フォルダの ID を保存する文字型データ項目（複数行）を準備
  const fileIdsDef = engine.createDataDefinition('共有するファイル/フォルダの ID', 1, 'q_fileIds', 'STRING_TEXTAREA');
  engine.setData(fileIdsDef, fileIds);
  configs.putObject('conf_FileIdsItem', fileIdsDef);
  
  configs.put('conf_SharedRange', sharedRange);
  configs.put('conf_Domain', domain);
  configs.putObject('conf_AllowFileDiscovery', allowFileDiscovery);
  configs.putObject('conf_Editable', editable);
  
  // 共有したファイル/フォルダの表示 URL を保存する文字型データ項目（複数行）を準備
  const sharedUrlItemDef = engine.createDataDefinition('作成したフォルダの表示 URL', 2, 'q_AddedSheetTitle', 'STRING_TEXTAREA');
  engine.setData(sharedUrlItemDef, '事前文字列');
  configs.putObject('conf_SharedUrlItem', sharedUrlItemDef);
  
  return sharedUrlItemDef;
};

/**
 * 設定の準備-共有したファイル/フォルダの表示 URL を保存する文字型データ項目が単一行
 * @param fileIds
 * @param sharedRange
 * @param domain
 * @param allowFileDiscovery
 * @param editable
 * @return sharedUrlItemDef
 */
const prepareConfigs_single_line = (fileIds, sharedRange, domain, allowFileDiscovery, editable) => {
  const quser = engine.createQuser(3, 'サウスポール', 'SouthPole@questetra.com');
  configs.putObject('conf_UserID', quser);
  
  // 共有するファイル/フォルダの ID を保存する文字型データ項目（複数行）を準備
  const fileIdsDef = engine.createDataDefinition('共有するファイル/フォルダの ID', 1, 'q_fileIds', 'STRING_TEXTAREA');
  engine.setData(fileIdsDef, fileIds);
  configs.putObject('conf_FileIdsItem', fileIdsDef);
  
  configs.put('conf_SharedRange', sharedRange);
  configs.put('conf_Domain', domain);
  configs.putObject('conf_AllowFileDiscovery', allowFileDiscovery);
  configs.putObject('conf_Editable', editable);
  
  // 共有したファイル/フォルダの表示 URL を保存する文字型データ項目（単数行）を準備
  const sharedUrlItemDef = engine.createDataDefinition('作成したフォルダの表示 URL', 2, 'q_AddedSheetTitle', 'STRING_TEXTFIELD');
  engine.setData(sharedUrlItemDef, '事前文字列');
  configs.putObject('conf_SharedUrlItem', sharedUrlItemDef);
  
  return sharedUrlItemDef;
};

/**
 * UserID に対応する QuserView がない場合
 */
test('User not found', () => {
  prepareConfigs('abc123', PUBLIC, '', false, false);
  configs.put('conf_UserID', '');
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith('User not found');
  }
});

/**
 * 共有範囲がドメインなのにドメインが空でエラーになる場合
 */
test('domain is blank', () => {
  prepareConfigs('abc456', DOMAIN, '', false, true);
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith("Domain to share isn't set.");
  }
});

/**
 * 共有するファイル/フォルダの ID が空でエラーになる場合
 */
test('File / Folder IDs is blank', () => {
  prepareConfigs(null, PUBLIC, '', true, true);
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith('File / Folder IDs aren\'t set.');
  }
});

/**
 * 共有するファイル/フォルダの ID が空行でエラーになる場合
 */
test('File / Folder IDs is blank line', () => {
  prepareConfigs('\n\n\n', DOMAIN, 'test1.com', true, false);
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith('File / Folder IDs aren\'t set.');
  }
});

/**
 * 共有するファイル/フォルダの ID が通信制限数を超えてエラーになる場合
 */
test('Number of File / Folder IDs is over the limit', () => {
  let ids = '';
  for (let i = 0; i <= httpClient.getRequestingLimit() / 2; i++) {
    ids += `f${i}\n`;
  }
  prepareConfigs(ids, PUBLIC, '', false, false);
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith('Number of File IDs is over the limit.');
  }
});

/**
 * 共有するファイル/フォルダの ID が複数行で URL 出力先のデータ項目が単一行エラーになる場合
 */
test('SharedUrl is Single-line String data for Multiple ids', () => {
  prepareConfigs_single_line(`abc123\ndef456`, DOMAIN, 'test2.com', false, true);
  
  // 共有したファイル/フォルダの表示 URL を保存するデータ項目(単一行)を準備
  const sharedUrlItemDef = engine.createDataDefinition('作成したフォルダの表示 URL', 2, 'q_AddedSheetTitle', 'STRING_TEXTFIELD');
  engine.setData(sharedUrlItemDef, '事前文字列');
  configs.putObject('conf_SharedUrlItem', sharedUrlItemDef);
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith('Multiple ids are set though the Data Item to save the output is Single-line String.');
  }
});

/**
 * POST リクエストのテスト
 * @param {Object} request
 * @param request.url
 * @param request.method
 * @param request.contentType
 * @param request.body
 * @param fileIds
 * @param sharedRange
 * @param domain
 * @param allowFileDiscovery
 * @param editable
 */
const assertPostRequest = ({url, method, contentType, body}, fileIds, sharedRange, domain, allowFileDiscovery, editable) => {
  expect(url).toEqual(`https://www.googleapis.com/drive/v3/files/${fileIds}/permissions?supportsAllDrives=true`);
  expect(method).toEqual('POST');
  expect(contentType).toEqual('application/json; charset=UTF-8');
  const bodyObj = JSON.parse(body);
  
  if (editable === true) {
    expect(bodyObj.role).toEqual('writer');
  } else {
    expect(bodyObj.role).toEqual('reader');
  }
  
  if (sharedRange === "domain"){
    expect(bodyObj.type).toEqual('domain');
    expect(bodyObj.domain).toEqual(domain);
  } else {
    expect(bodyObj.type).toEqual('anyone');
  }
  
  expect(bodyObj.allowFileDiscovery).toEqual(allowFileDiscovery);
};

/**
 * POST API リクエストでエラー
 */
test('POST Failed', () => {
  prepareConfigs('abc789', DOMAIN, 'test3.com', true, true);
  
  httpClient.setRequestHandler((request) => {
    assertPostRequest(request, 'abc789', DOMAIN, 'test3.com', 'true', true);
    return httpClient.createHttpResponse(400, 'application/json', '{}');
  });
  
  // <script> のスクリプトを実行し、エラーがスローされることを確認
  try {
    execute();
    fail('not come here');
  } catch (e) {
    expect(e.message).endsWith('Failed to create permission:abc789\nStatus:400');
  }
});

/**
 * GET リクエストのテスト
 * @param {Object} request
 * @param request.url
 * @param request.method
 * @param fileIds
 */
const assertGetRequest = ({url, method}, fileIds) => {
  expect(url).toEqual(`https://www.googleapis.com/drive/v3/files/${fileIds}?fields=webViewLink`);
  expect(method).toEqual('GET');
};

/**
 * 共有するファイル/フォルダの ID の数が１つの場合
 */
test('Succeed to share 1 File / Folder ID', () => {
  const sharedUrlItemDef = prepareConfigs_single_line('def123', DOMAIN, 'test4.com', true, false);
 
  let reqCount = 0;
  httpClient.setRequestHandler((request) => {
    if (reqCount === 0) {
      assertPostRequest(request, 'def123', DOMAIN, 'test4.com', 'true,' false);
      reqCount++;
      return httpClient.createHttpResponse(200, 'application/json', '{}');
    }
    assertGetRequest(request, 'def123');
    return httpClient.createHttpResponse(200, 'application/json', ' {"webViewLink":"https://docs.google.com/spreadsheets/d/def123/edit?usp=drivesdk"}');
  });
  
  // <script> のスクリプトを実行
  execute();
  
  // 文字型データ項目の値をチェック
  expect(engine.findData(sharedUrlItemDef)).toEqual('https://docs.google.com/spreadsheets/d/def123/edit?usp=drivesdk');
});

/**
 * 共有するファイル/フォルダの ID の数が複数(最大リクエスト数)の場合
 */
test('Succeed to share multiple File / Folder IDs', () => {
  let ids = '';
  let urls = '';
  for (let i = 0; i < httpClient.getRequestingLimit() / 2; i++) {
    ids += `f${i}\n`;
    urls += `https://docs.google.com/spreadsheets/d/f${i}/edit?usp=drivesdk`;
  }
  const sharedUrlItemDef = prepareConfigs(ids, PUBLIC, '', 'false', true);
  
  let reqCount = 0;
  let fileCount = 0;
  httpClient.setRequestHandler((request) => {
    if (reqCount% 2 === 0) {
      assertPostRequest(request, `f${fileCount}`, PUBLIC, '', 'false', true);
      reqCount++;
      return httpClient.createHttpResponse(200, 'application/json', '{}');
    } else {
      assertGetRequest(request, `f${fileCount}`);
      reqCount++;
      return httpClient.createHttpResponse(200, 'application/json', `{"webViewLink":"https://docs.google.com/spreadsheets/d/f${fileCount++}/edit?usp=drivesdk"}`);
    }
  });
  
  // <script> のスクリプトを実行
  execute();
  
  // 文字型データ項目の値をチェック
  // expect(engine.findData(sharedUrlItemDef)).toEqual(urls);
});


]]></test>
</service-task-definition>