<?xml version="1.0" encoding="UTF-8"?>
<service-task-definition>
    <last-modified>2022-05-10</last-modified>
    <license>(C) Questetra, Inc. (MIT License)</license>
    <engine-type>2</engine-type>
    <label>Box: Add Metadata to File</label>
    <label locale="ja">Box: ファイルにメタデータ追加</label>
    <summary>This item adds metadata to the specified file on Box, using a metadata template defined within your enterprise.</summary>
    <summary locale="ja">この工程は、会社内で定義されたメタデータテンプレートを利用して、Box 上のファイルにメタデータを追加します。</summary>
    <help-page-url>https://support.questetra.com/bpmn-icons/service-task-box-file-metadata-add/</help-page-url>
    <help-page-url locale="ja">https://support.questetra.com/ja/bpmn-icons/service-task-box-file-metadata-add/
    </help-page-url>
    <configs>
        <config name="conf_OAuth2" required="true" form-type="OAUTH2"
                oauth2-setting-name="https://app.box.com/api/oauth2/root_readwrite">
            <label>C1: OAuth2 Setting</label>
            <label locale="ja">C1: OAuth2 設定</label>
        </config>
        <config name="conf_FileId" required="true" form-type="SELECT" select-data-type="STRING_TEXTFIELD">
            <label>C2: File ID to add metadata to</label>
            <label locale="ja">C2: メタデータを追加するファイル ID</label>
        </config>
        <config name="conf_TemplateKey" required="true" form-type="TEXTFIELD">
            <label>C3: Metadata Template Key</label>
            <label locale="ja">C3: メタデータテンプレートキー</label>
        </config>
        <config name="conf_FieldKey1" form-type="TEXTFIELD">
            <label>C-K1: Key for Field 1</label>
            <label locale="ja">C-K1: フィールド 1 のキー</label>
        </config>
        <config name="conf_FieldValue1" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V1: Value for Field 1</label>
            <label locale="ja">C-V1: フィールド 1 の値</label>
        </config>
        <config name="conf_FieldKey2" form-type="TEXTFIELD">
            <label>C-K2: Key for Field 2</label>
            <label locale="ja">C-K2: フィールド 2 のキー</label>
        </config>
        <config name="conf_FieldValue2" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V2: Value for Field 2</label>
            <label locale="ja">C-V2: フィールド 2 の値</label>
        </config>
        <config name="conf_FieldKey3" form-type="TEXTFIELD">
            <label>C-K3: Key for Field 3</label>
            <label locale="ja">C-K3: フィールド 3 のキー</label>
        </config>
        <config name="conf_FieldValue3" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V3: Value for Field 3</label>
            <label locale="ja">C-V3: フィールド 3 の値</label>
        </config>
        <config name="conf_FieldKey4" form-type="TEXTFIELD">
            <label>C-K4: Key for Field 4</label>
            <label locale="ja">C-K4: フィールド 4 のキー</label>
        </config>
        <config name="conf_FieldValue4" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V4: Value for Field 4</label>
            <label locale="ja">C-V4: フィールド 4 の値</label>
        </config>
        <config name="conf_FieldKey5" form-type="TEXTFIELD">
            <label>C-K5: Key for Field 5</label>
            <label locale="ja">C-K5: フィールド 5 のキー</label>
        </config>
        <config name="conf_FieldValue5" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V5: Value for Field 5</label>
            <label locale="ja">C-V5: フィールド 5 の値</label>
        </config>
        <config name="conf_FieldKey6" form-type="TEXTFIELD">
            <label>C-K6: Key for Field 6</label>
            <label locale="ja">C-K6: フィールド 6 のキー</label>
        </config>
        <config name="conf_FieldValue6" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V6: Value for Field 6</label>
            <label locale="ja">C-V6: フィールド 6 の値</label>
        </config>
        <config name="conf_FieldKey7" form-type="TEXTFIELD">
            <label>C-K7: Key for Field 7</label>
            <label locale="ja">C-K7: フィールド 7 のキー</label>
        </config>
        <config name="conf_FieldValue7" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V7: Value for Field 7</label>
            <label locale="ja">C-V7: フィールド 7 の値</label>
        </config>
        <config name="conf_FieldKey8" form-type="TEXTFIELD">
            <label>C-K8: Key for Field 8</label>
            <label locale="ja">C-K8: フィールド 8 のキー</label>
        </config>
        <config name="conf_FieldValue8" form-type="TEXTFIELD" el-enabled="true">
            <label>C-V8: Value for Field 8</label>
            <label locale="ja">C-V8: フィールド 8 の値</label>
        </config>
    </configs>

    <script><![CDATA[

const FIELD_NUM = 8; // 扱えるフィールドの数

main();
function main(){
    const oauth2 = configs.get('conf_OAuth2');
    const fileId = decideFileId();
    const templateKey = configs.get('conf_TemplateKey');
    const metadataObj = retrieveMetadata();

    addMetadata(oauth2, fileId, templateKey, metadataObj);
}

/**
  * ファイル ID を config から読み出して出力する
  * @return {String} fileId ファイル ID
  */
function decideFileId(){
    const fileId = engine.findData(configs.getObject('conf_FileId'));
    if (fileId === '' || fileId === null) {
        throw 'File ID is blank.';
    }
    return fileId;
}

/**
  * 追加するメタデータの情報を config から読み出して出力する
  * @return {Object} metadataObj 追加するメタデータ
  */
function retrieveMetadata(){
    const metadataObj = {};
    for (let i = 0; i < FIELD_NUM; i++) {
        const keyConfigName = `conf_fieldKey${i+1}`;
        const valueConfigName = `conf_fieldValue${i+1}`;

        const key = configs.get(keyConfigName);
        if (key === '' || key === null) { // キーが空
            continue;
        }
        if (metadataObj[key] !== undefined) { // キーの指定が重複
            throw `The Field Key "${key}" is set multiple times.`;
        }
        const value = configs.get(valueConfigName);
        metadataObj[key] = value;
    }
    return metadataObj;
}

/**
  * メタデータを追加
  * @param {String} oauth OAuth2 設定
  * @param {String} fileId ファイル ID
  * @param {String} templateKey テンプレートキー
  * @param {Object} metadataObj 追加するメタデータ
  */
function addMetadata(oauth2, fileId, templateKey, metadataObj) {
    const url = `https://api.box.com/2.0/files/${encodeURIComponent(fileId)}/metadata/enterprise/${encodeURIComponent(templateKey)}`;
    const response = httpClient.begin()
        .authSetting(oauth2)
        .body(JSON.stringify(metadataObj), 'application/json; charset=UTF-8')
        .post(url);
    const status = response.getStatusCode();
    if (status !== 201) {
        engine.log(response.getResponseAsString());
        throw `Failed to add metadata. status:${status}`;
    }
}

    ]]></script>

    <icon>iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEBElEQVRYR82Xb2jbRRjHP/fL2jXJ
        0qSd65x11aK0YgJWZUwEWZ0DfSNaHYKKmgykbP7pH/SVghvCkIlb6kREwfyGOougbgxB2Yt1oGwg
        aietdOJoV21ty2ob26xdm+TkLsufJr+2Sdtt3pv8uDx3z+ee+z53zwmucRMF+ff/9ijEtwB1IDwI
        9QtIOkGOA50I0UHIezTfeRcH8Pd64GITyGaE8OQ1sVQwIgiONsxqBTZvWxjA3+UHDuTtONuNBjEC
        mLcfmY9gfgB/dxBBU14rXsxIyiCmr8XKzBog0GWCeG6xeQv6X2JiegPZY3IBVnLlOVtCG6a3ObN7
        LoDacyFCBa2sUGMpGjI1kQbQao/0Lllw+YJoYTqrk9mRAdC9G8Eb+c6zLDvJHkzvbjVHGiDQpXLX
        nZw4tOMGyp02Hjn457J8WQ5WUTB9ZWkAdcIJ+XWm8XCwFkexwLWrZ+UB9OmZ0EIiAhbKH2lLAKzZ
        eaUAEhmRAAh0dYBQZ3yqKQDnaoPDp8PUVZXo/pM9EV75Ylh/77q/jO2bSlmz2mBgLErjoUHad95I
        Z/80re0Jmw+e3UD1dcU8uP+8RRTlSUK++ssA3X3ATdkA61y2nIE/9k7Rd2GWx+4uxWZkAP8bo9Ru
        YAho+XyIUruNNxsqiMzE8bxgEUV1gZneO5MAMtuTioACUM7e+W4Uj8Pg5W1rdV9cwvSsxPx+nNPn
        LvLStnI2VdsZi8TwOGyMTsY0nNth493j/9DSPmSto5BXLAigsmDLW7388MeUnuDVh9ay74n1+vvI
        zxM0vJfOkNGDtdiLDH7pn+beW+3a5kRPhK37rMJ/mScDIGcLBvfXsM61isrWs4xMxPSIpza7+ayx
        Un8rbTz94UBqZX8fqNFp+82vkzTc5dL9n54K88xHaZu5YZBnCPnq5hXhqdequecWO2rPH3j7PBvc
        qzjWVEXN9cV6HhVmJbwvf5rgcGMlT2526y1wldiYiUl9wKhtUHp4/8TYIiK0SMP6WgdfvbiRMqeN
        yKU4NkNQUiToH51lcDyq4aIxtMjcdoOpGYkSkrJpOz6qt6OxvowLkzEqms7mAsjMNLQ4iNSIrbc5
        2bu9QqdSNC7pHrjEjo8H+GssyifPV3JfjQNHscFQOMqeoyPsfXw9vw/P8HBbv3b4bWsVG8uL8L5+
        zgIg8yBSf2cdxdayXaleGSbk0+Xd/+gyUtexiPRlXkgrtd4s9YeRzptzr2NldU0LkiTmlS3JUnVA
        0t3VK0qRhwj5VJk/p12lsjxdAeUPoDWhCpW4KtFTlVJhwpRhpOFf2sMkpQn9NGtGyOb8QZRj/TQL
        Lu9plr1c/TiV9QipHqUeEHckTOQZYBwpOkF0LLTiwragsHgvyfo/g3CBMFgjn40AAAAASUVORK5C
        YII=
    </icon>

</service-task-definition>