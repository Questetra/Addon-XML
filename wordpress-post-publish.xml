<?xml version="1.0" encoding="UTF-8"?>
<service-task-definition>
    <engine-type>3</engine-type>
    <addon-version>2</addon-version>
    <!--
    <last-modified>2023-11-13</last-modified>
    -->
    <license>(C) Questetra, Inc. (MIT License)</license>
    <label>WordPress.com: Publish Post</label>
    <label locale="ja">WordPress.com: 記事公開</label>
    <summary>This item publishes an existing post on WordPress.com. When the publish datetime is not specified, the post will be immediately published.</summary>
    <summary locale="ja">この工程は、WordPress.com で作成済みの記事（投稿）を公開します。公開日時を指定しない場合、即座に公開されます。</summary>
    <help-page-url>https://support.questetra.com/bpmn-icons/service-task-wordpress-post-publish/</help-page-url>
    <help-page-url locale="ja">https://support.questetra.com/ja/bpmn-icons/service-task-wordpress-post-publish/</help-page-url>
    <configs>
        <config name="conf_Auth" required="true" form-type="OAUTH2" auth-type="OAUTH2"
                oauth2-setting-name="https://public-api.wordpress.com/posts"
        >
            <label>C1: OAuth2 Setting</label>
            <label locale="ja">C1: OAuth2 設定</label>
        </config>
        <config name="conf_Domain" required="true" form-type="TEXTFIELD">
            <label>C2: Domain of the WordPress.com site</label>
            <label locale="ja">C2: WordPress.com サイトのドメイン</label>
        </config>
        <config name="conf_PostId" required="true" form-type="SELECT" select-data-type="STRING_TEXTFIELD">
            <label>C3: Post ID</label>
            <label locale="ja">C3: 投稿 ID</label>
        </config>
        <config name="conf_Date" form-type="SELECT" select-data-type="DATETIME">
            <label>C4: Publish Datetime (If in future, schedule publish)</label>
            <label locale="ja">C4: 公開日時（未来の日時を指定した場合、公開が予約されます）</label>
        </config>
    </configs>

    <script><![CDATA[
// OAuth2 config sample at [OAuth 2.0 Setting]
// - Authorization Endpoint URL: https://public-api.wordpress.com/oauth2/authorize
// - Token Endpoint URL: https://public-api.wordpress.com/oauth2/token
// - Scope: posts
// - Client ID: (Get by https://developer.wordpress.com/apps/)
// - Client Secret: (Get by https://developer.wordpress.com/apps/)

const main = () => {
    const auth = configs.getObject('conf_Auth');
    const domain = configs.get('conf_Domain');
    const postId = retrievePostId();
    const date = retrieveDate();

    publishPost(auth, domain, postId, date);
};

/**
 * config から投稿 ID を読み出す
 * 空の場合、数字以外の文字が含まれる場合はエラー
 * @returns {String} postId
 */
const retrievePostId = () => {
    const postId = engine.findData(configs.getObject('conf_PostId'));
    if (postId === null) {
        throw 'Post ID is blank.';
    }
    const idReg = new RegExp('^[0-9]+$');
    if (!idReg.test(postId)) {
        throw 'Post ID must be a non-negative integer.';
    }
    return postId;
};

/**
 * config から公開日時を文字列として読み出す
 * データ項目が選択されていない場合、空文字列を返す
 * データ項目が選択されていて値が空の場合は、エラー
 * @returns {String} date
 */
const retrieveDate = () => {
    const dateDef = configs.getObject('conf_Date');
    if (dateDef === null) {
        return '';
    }
    const datetimeObj = engine.findData(dateDef);
    if (datetimeObj === null) {
        throw 'Publish Datetime is selected but its data is null.';
    }
    return dateFormatter.format("yyyy-MM-dd'T'HH:mm:ssX", datetimeObj);
};

/**
 * 記事を公開 / 公開予約する
 * @param {AuthSettingWrapper} auth
 * @param {String} domain
 * @param {String} postId
 * @param {String} date
 * @returns {any}
 */
const publishPost = (auth, domain, postId, date) => {
    const url = `https://public-api.wordpress.com/rest/v1.1/sites/${encodeURIComponent(domain)}/posts/${postId}`;
    const response = httpClient.begin().authSetting(auth)
        .queryParam('fields', 'URL,status,date')
        .formParam('status', 'publish')
        .formParam('date', date)
        .post(url);
    const status = response.getStatusCode();
    const responseStr = response.getResponseAsString();
    if (status !== 200) {
        engine.log(responseStr);
        throw `Failed to publish post. status: ${status}`;
    }
    engine.log(`Successfully published post. ${responseStr}`);
};

    ]]></script>

    <icon>
        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
    </icon>

    <test><![CDATA[

    ]]></test>

</service-task-definition>
