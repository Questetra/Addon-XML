<?xml version="1.0" encoding="UTF-8"?><service-task-definition>

<label>New Record to Google Sheets (Table)</label>
<label locale="ja">Google Sheets 行追加 (Table)</label>

<last-modified>2019-11-15</last-modified>
<help-page-url>https://support.questetra.com/ja/addons/googlesheets-appendtable/</help-page-url>
<help-page-url locale="ja">https://support.questetra.com/addons/googlesheets-appendtable/</help-page-url>

<configs>
  <config name="conf_OAuth2" required="true" form-type="OAUTH2">
    <label>C1: OAuth2 Config Name</label>
    <label locale="ja">C1: OAuth2設定名</label>
  </config>
  <config name="conf_DataIdW" required="true" form-type="TEXTFIELD">
    <label>C2: Target Spreadsheet ID</label>
    <label locale="ja">C2: 入力先のスプレッドシートの ID</label>
  </config>
  <config name="conf_DataIdX" required="true" form-type="TEXTFIELD">
    <label>C3: Target Sheet Title</label>
    <label locale="ja">C3: 入力先のシートのタイトル</label>
  </config>
  <config name="conf_DataIdT" required="true" form-type="SELECT" select-data-type="LIST">
    <label>C4: TABLE DATA</label>
    <label locale="ja">C4: テーブル型データ項目</label>
  </config>
  <config name="conf_DataIdA" required="false" form-type="TEXTFIELD">
    <label>C-A: Column-A Value of New Row</label>
    <label locale="ja">C-A: 末尾行の A 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdB" required="false" form-type="TEXTFIELD">
    <label>C-B: Column-B Value of New Row</label>
    <label locale="ja">C-B: 末尾行の B 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdC" required="false" form-type="TEXTFIELD">
    <label>C-C: Column-C Value of New Row</label>
    <label locale="ja">C-C: 末尾行の C 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdD" required="false" form-type="TEXTFIELD">
    <label>C-D: Column-D Value of New Row</label>
    <label locale="ja">C-D: 末尾行の D 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdE" required="false" form-type="TEXTFIELD">
    <label>C-E: Column-E Value of New Row</label>
    <label locale="ja">C-E: 末尾行の E 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdF" required="false" form-type="TEXTFIELD">
    <label>C-F: Column-F Value of New Row</label>
    <label locale="ja">C-F: 末尾行の F 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdG" required="false" form-type="TEXTFIELD">
    <label>C-G: Column-G Value of New Row</label>
    <label locale="ja">C-G: 末尾行の G 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdH" required="false" form-type="TEXTFIELD">
    <label>C-H: Column-H Value of New Row</label>
    <label locale="ja">C-H: 末尾行の H 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdI" required="false" form-type="TEXTFIELD">
    <label>C-I: Column-I Value of New Row</label>
    <label locale="ja">C-I: 末尾行の I 列に追加されるテーブル型データ項目の列</label>
  </config>
  <config name="conf_DataIdJ" required="false" form-type="TEXTFIELD">
    <label>C-J: Column-J Value of New Row</label>
    <label locale="ja">C-J: 末尾行の J 列に追加されるテーブル型データ項目の列</label>
  </config>
</configs>

<script><![CDATA[
// Append Table Records to Google Sheets (ver. 20160915)
// (c) 2016, Questetra, Inc. (the MIT License)

// OAuth2 config
// Authorization Endpoint URL: https://accounts.google.com/o/oauth2/auth?access_type=offline&approval_prompt=force
// Token Endpoint URL: https://accounts.google.com/o/oauth2/token
// Scope: https://www.googleapis.com/auth/spreadsheets
// Consumer Key: (Get by Google Developers Console)
// Consumer Secret: (Get by Google Developers Console)

//// == 自動工程コンフィグの参照 / Config Retrieving ==
var dataIdT = configs.get( "conf_DataIdT" ); // (returns Number)
var oauth2 = configs.get( "conf_OAuth2" );
const spreadsheetId = configs.get( "conf_DataIdW" ) + "";
const sheetName = configs.get( "conf_DataIdX" ) + "";
const dataIdA = configs.get( "conf_DataIdA" ) + "";
const dataIdB = configs.get( "conf_DataIdB" ) + "";
const dataIdC = configs.get( "conf_DataIdC" ) + "";
const dataIdD = configs.get( "conf_DataIdD" ) + "";
const dataIdE = configs.get( "conf_DataIdE" ) + "";
const dataIdF = configs.get( "conf_DataIdF" ) + "";
const dataIdG = configs.get( "conf_DataIdG" ) + "";
const dataIdH = configs.get( "conf_DataIdH" ) + "";
const dataIdI = configs.get( "conf_DataIdI" ) + "";
const dataIdJ = configs.get( "conf_DataIdJ" ) + "";
//// == ワークフローデータの参照 / Data Retrieving ==
var myTable = engine.getDataByNumber( dataIdT );
// myTable: com.questetra.bpms.core.model.formdata.ListArray

//// == 演算 / Calculating ==
var accessLog = "";
var responseJson = "";
var sheetId = -1;
var token = httpClient.getOAuth2Token( oauth2 );

try{
  // check spreadsheet
  var uri = "https://sheets.googleapis.com/v4/spreadsheets/";
  uri += docId;
  uri += "?includeGridData=false";
  var response = httpClient.begin()
    .bearer(token)
    .get( uri ); 
  accessLog += "---GET request--- " + response.getStatusCode() + "\n";
  responseJson = response.getResponseAsString();
  if( response.getStatusCode() == 200 ){
    var jsonObj = JSON.parse( responseJson );
    accessLog += " SPREADSHEET TITLE: \"" + jsonObj.properties.title + "\" has";
    accessLog += jsonObj.sheets.length + " sheets\n";
    for( var i = 0; i < jsonObj.sheets.length; i++ ){
      if( jsonObj.sheets[i].properties.title == sheet ){
        sheetId = parseInt( jsonObj.sheets[i].properties.sheetId, 10 );
        accessLog += " SHEET TITLE: \"" + sheet + "\" exists (id: " + sheetId + ")\n";
      }else{
        accessLog += " SHEET TITLE: \"" + sheet + "\" does not exist\n";
      }
    }
  }else{
    sheetId = -2;
  }

  // add sheet (not exsist)
  if( sheetId == -1 ){  
    var uri2 = "https://sheets.googleapis.com/v4/spreadsheets/";
    uri2 += docId;
    uri2 += ":batchUpdate";

    sheetId = processInstance.getProcessInstanceId() - 0;
    var myObj2 = {};
    myObj2.requests = []; // Array
    myObj2.requests[0] = {};
    myObj2.requests[0].addSheet = {};
    myObj2.requests[0].addSheet.properties = {};
    myObj2.requests[0].addSheet.properties.sheetId = sheetId;
    myObj2.requests[0].addSheet.properties.title = sheet;

    var response2 = httpClient.begin()
      .bearer(token)
      .body( JSON.stringify( myObj2 ), "application/json" )
      .post( uri2 ); 
    accessLog += "---POST request--- " + response2.getStatusCode() + "\n";
    if( response2.getStatusCode() == 200 ){
      accessLog += " SHEET TITLE: \"" + sheet + "\" created (id: " + sheetId + ")\n";
    }
  }

  // append records
  if( sheetId >= 0 ){
    if( myTable !== null){
      var colIdArray = colIds.split(",");
      var numOfCols = colIdArray.length;
      var numOfRows = myTable.size() - 0; // 行（Tableの高さ）

      var myObj3 = {};
      myObj3.requests = []; // Array
      myObj3.requests[0] = {};
      myObj3.requests[0].appendCells = {};
      myObj3.requests[0].appendCells.rows = []; // Array
      myObj3.requests[0].appendCells.sheetId = sheetId;
      myObj3.requests[0].appendCells.fields = "*";

      for( var i = 0; i < numOfRows; i++ ){
        myObj3.requests[0].appendCells.rows[i] = {};
        myObj3.requests[0].appendCells.rows[i].values = []; // Array
        for( var j = 0; j < numOfCols; j++ ){
          if( colIdArray[j].slice(-1) == "n" ){
            var cellValue = myTable.get(i, parseInt( colIdArray[j] ) ) - 0;
            myObj3.requests[0].appendCells.rows[i].values[j]
            = {"userEnteredValue": {"numberValue" : cellValue } }; 
          }else if( colIdArray[j].slice(-1) == "d" ){
            var dateTimeSerialNumber = new Date( myTable.get(i, parseInt( colIdArray[j] ) ) )/86400000 + 25569;
            myObj3.requests[0].appendCells.rows[i].values[j]
            = {"userEnteredFormat": {"numberFormat": { "type": "DATE_TIME" } },
               "userEnteredValue": {"numberValue": dateTimeSerialNumber }}; 
          }else{
            var cellValue = myTable.get(i, parseInt( colIdArray[j] ) ) + "";
            myObj3.requests[0].appendCells.rows[i].values[j]
            = {"userEnteredValue": {"stringValue": cellValue }}; 
          }
        }
      }

      var uri3 = "https://sheets.googleapis.com/v4/spreadsheets/";
      uri3 += docId;
      uri3 += ":batchUpdate";

      var response3 = httpClient.begin()
        .bearer(token)
        .body( JSON.stringify( myObj3 ), "application/json" )
        .post( uri3 ); 
      accessLog += "---POST request--- " + response3.getStatusCode() + "\n";
      if( response3.getStatusCode() == 200 ){
        accessLog += " ADDED DATA: " + colIds + " x " + numOfRows + "cells\n";
      }
    }
  }
}catch(e){
  accessLog += e.message + "\n";
}

//// == ワークフローデータへの代入 / Data Updating ==
retVal.put( dataIdF, accessLog );
]]></script>


<icon>
iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACuUlEQVRYR82X0VHbQBCGd8UT8BA6iFMBTgXxIwjP4A4SKoBUEFNBTAU4HTgz6PCjqCCkgpAOnBf5Sfdnfs3JcxKSLBmUyc34wZLu9t/d2+/2VFqMk5OTwd7e3gcRGfIHYKCqA38qgCdVfRKRR/7SNH1YLpf83zi06W0Yhp9E5FJVabjzAPCoqrMoir7VTa4UMB6PR9ba27KXnRW4CYxOEAQXd3d3cXmNZwLotare7mqsaR6AC2PM3P+mIMDl+lcfxvM10zR95++NgoCzs7MrEfnapwAR+RxF0Sy3URDQZ/hzg+U0FASMRqOjg4MDltObPqIA4E+SJIM4jleVEeBDV3qz1xZB40EQTMqVUFmGYRiy7imC8HnxAPAgIlfGGEKqMBpBdHp6OlFVluX5LioAfAcwv7+/X7QCEasAAIwxN/4E7o39/f2RIyKjc8T3eYSch3zE3D6SgOv1OvZz7dI7VdVVUxXwgy+O69MmhLaNCMUfHh6eA7iiAwCujTHTujLMBHiLrwAwfAtr7c82h4vzdKiqxwAYtUkeMb7rKqDK0YznALJwu1SMvA83Kaqa/BoC2ka/7rtGEjJ0P15qoWk+gPd+OVadhqz/yz5EALgxxvC82Yw6EL26iCrj2f6p89TRkFWxE4TydQkjEZlWUfCZAJKvDBD2CEEQcJeznLhH3m7J8W9XHYskSRY+jLgWWeCTsXwc0+NLALMkSW7KJMsNMzpBEGQ0zIe1dlXnpTtl2VuStNwHrUC0gZAxhmHsPFxv+dGH0a4cyKGTtdzW2sp2W1VJPkaGMPLhtBG/q4DO3tdN+L8F/IumtLEndCXH20xvPaG1dljbljNvfXbGWy8m+cZx5TPfBp22OxMA4TTp3BO6aPDwOG5rzP/OtWrz8nVs62FUNubhOLueiwiRWkCy83JzPbfWxm06qL/sgpkwsGVshgAAAABJRU5ErkJggg==
</icon>

</service-task-definition>
