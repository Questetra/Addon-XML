<?xml version="1.0" encoding="UTF-8"?><service-task-definition>
<label>OneDrive: Delete File / Folder</label>
<label locale="ja">OneDrive: ファイル / フォルダ削除</label>
<last-modified>2020-04-03</last-modified>
<license>(C) Questetra, Inc. (MIT License)</license>
<engine-type>1</engine-type>
<summary>Delete files and folders on OneDrive. You can delete multiple ones at once. When you delete multiple ones, you should write one ID on each line.</summary>
<summary locale="ja">OneDrive 上のファイル / フォルダを削除します。一度に複数の削除が可能です。複数削除する場合、データ項目では1行につき1つずつIDを書くようにしてください。</summary>
<configs>
  <config name="OAuth2" required="true" form-type="OAUTH2" oauth2-setting-name="https://graph.microsoft.com/Files.ReadWrite">
    <label>C1: OAuth2 Setting Name</label>
    <label locale="ja">C1: OAuth2 設定名</label>
  </config>
  <config name="itemIds" required="true" form-type="SELECT" select-data-type="STRING" >
    <label>C2: Data Item with File / Folder IDs to delete</label>
    <label locale="ja">C2: 削除するファイル / フォルダの ID が保存されている文字型データ項目</label>
  </config>
</configs>
<help-page-url>https://support.questetra.com/addons/onedrive-file-delete/</help-page-url>
<help-page-url locale="ja">https://support.questetra.com/ja/addons/onedrive-file-delete/</help-page-url>

<script><![CDATA[
// OAuth2 config sample at [OAuth 2.0 Setting]
// - Authorization Endpoint URL: https://login.microsoftonline.com/common/oauth2/v2.0/authorize
// - Token Endpoint URL: https://login.microsoftonline.com/common/oauth2/v2.0/token
// - Scope: https://graph.microsoft.com/Files.ReadWrite offline_access
// - Consumer Key: (Get by Microsoft Azure Active Directory)
// - Consumer Secret: (Get by Microsoft Azure Active Directory)
main();

function main(){
  //// == 工程コンフィグの参照 / Config Retrieving ==
  const oauth2 = configs.get("OAuth2");
  const idsConfig = configs.get("itemIds");
  
  //// == ワークフローデータの参照 / Data Retrieving ==
  const ids = engine.findDataByNumber(idsConfig);
  if (ids === "" || ids === null) {
    throw "File / Folder IDs aren't set.";
  }
  const idArray = ids.split("\n");
  const fileNum = idArray.length;
  if (fileNum > httpClient.getRequestingLimit()){
  	throw "Number of File / Folder IDs is over the limit.";
  }
  //// == 演算 / Calculating ==
  const token = httpClient.getOAuth2Token(oauth2);
  for (let i = 0; i < fileNum; i++){
    deleteItem(token, idArray[i]);
  }
}

/**
  * ファイル/フォルダを削除する。
  * @param {String} token  OAuth2 トークン
  * @param {String} id  アイテムの ID
  */
function deleteItem(token,id){
  const url = `https://graph.microsoft.com/v1.0/me/drive/items/${id}`;
  let response = httpClient.begin()
    .bearer(token)
    .delete(url);
  
  const responseJson = response.getResponseAsString();
  const status = response.getStatusCode();
  if (status >= 300) {
    //when error thrown
    throw `failed to delete: ${id}
    status: ${status}
    ${responseJson}`;
  }
  engine.log(`Item ID: ${id}`);
  engine.log("delete successful");
}
  ]]>
</script>

<icon>
iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADXUlEQVRYR8WXW0hUURSG/33GbC5e
8pJJF6nM6YKUmsFAIAZSONOM4FtqL/mQVg9GhXR5iCIiEAqF9KEMsvKpi06OZoRPGaRmVoSGU4om
aqaMzeXYOLPjTJ7R41w8k8bZLwNn1r/Wt9dee+29CSQeRHR8vVEpd7vzGTAHKKXpADYDiJnTTwEY
IIR0u+FuYxnmCYx6uxjfSwKotE2JbuoqB0EJALkYpwBYUNQwRHbDZtKNBtMEBVBqG0ooSAUAlcjA
i81sBPSs3ZRXE0gfEECuM94mlJb+Y2CBjBJSzTbpT/jz5RdAoTU+BGjBSgSf90EeOUz6wsU+fQBW
cuaLg/nLhABgbs2rV3bmQm8EtHRhTXgBPNUOV/8yCk4st42BbBu/O7wAitzGmyAoE+tlWXYUtxzN
htOcj78AeqNS4aI/Q9jneH5Ng0x1DCLkMlhZFz59m0ZZ9UfPr4jBOmQkjmtWHgC5rqGIUFIXTHih
QI3UzVHoH7HhsCYROzZF+JgPjNqxq/iViPgAJfQo25T3wAOg1BnvUkqP+VNGKsLQXpmF5PXCXmR1
zKJvyAqL3Yn4qHCoN0ZCHs6gvm0YxRXdS0IQQmrtTfpiD4BC2/gOANfffUbjVQ1yMtYKvnNZGJlg
kZESDeVqGSy2WbzoHPdkpdtswcnKniUBAHQ7TIYMHmBywcEiEPfey0FSgsL7zWJzosc8jazdcQI7
l5tiwvIbUaowTE47UfXMjMqnX4OBTDlMhlgegC62TNmgwp0z6UhLjsaqMMbzN5f25o4x5O5bhwhF
WNBZ2mdcyDn3Gu/NloB2DpOBBAToqs7GzqRIr/j7BIu+4V9I2xqN2KhwMSlGbcsgTlV9EAXgswSW
Bp135pQCrV3jOJSZICowb2RjXWjtHEfh9U5/OsES+BThj8daqOQyb+q/DFuRkbImJADOmKuNg+Xt
ePOZm6NgzBehv21YfzETek0iGIZgxun2OMjeEx8yACfIv/wWLR1jAq1gGwZqROePqLE/NRZjUzOo
ezmE++V7ER8tbv35aFzm0o63+YALGlEorfhS0XZsSVSKysTgmANX6nr92QpbMWch7WHEncFSH8dc
FiS9kPALJemVjIeQ9FL6PzIR8rWch5D0YcJDSPo0E3QQqR6nolreMoz+ACVfiTBvFfnjAAAAAElF
TkSuQmCC
</icon>

</service-task-definition>
