<?xml version="1.0" encoding="UTF-8"?><service-task-definition>

<label>(Any Website): File Download</label>
<label locale="ja">(任意Webサイト): ファイル ダウンロード</label>

<summary>Downloads a file and adds to file-type data. The GET request to the URL is thrown and the response is saved as a file. It is also possible to rename the file name.</summary>
<summary locale="ja">ファイルをダウンロードし、ファイル型データに追加します。指定したURLへGETリクエストが投げられ、そのレスポンスがファイルとして保存されます。別名保存も可能です。</summary>

<license>(C) Questetra, Inc. (MIT License)</license>
<engine-type>1</engine-type>
<last-modified>2019-01-07</last-modified>

<help-page-url>https://support.questetra.com/addons/any-website-file-download/</help-page-url>
<help-page-url locale="ja">https://support.questetra.com/ja/any-website-file-download/</help-page-url>

<configs>
  <config name="conf_DataIdA" required="true" form-type="SELECT" select-data-type="STRING_TEXTFIELD|SELECT_SINGLE">
    <label>A: Select STRING/SELECT DATA for File URL</label>
    <label locale="ja">A: File URL が格納されている文字列型or選択肢型データを選択してください</label>
  </config>
  <config name="conf_DataIdB" required="true" form-type="SELECT" select-data-type="FILE">
    <label>B: Select FILE DATA for Downloaded File (update)</label>
    <label locale="ja">B: ダウンロードファイルが追加格納されるファイル型データを選択してください (更新)</label>
  </config>
  <config name="conf_SaveAs" required="false" el-enabled="true" form-type="TEXTFIELD">
    <label>Bx: Set the file name if you want to save as a different name</label>
    <label locale="ja">Bx: 別名保存したい場合はファイル名をセットしてください</label>
  </config>
  <config name="conf_DataIdC" required="false" form-type="SELECT" select-data-type="STRING">
    <label>C: Select STRING DATA for Content Type (update)</label>
    <label locale="ja">C: Content Type が格納される文字列型データを選択してください (更新)</label>
  </config>
  <config name="conf_DataIdD" required="false" form-type="SELECT" select-data-type="DECIMAL">
    <label>D: Select NUMERIC DATA for Byte Size (update)</label>
    <label locale="ja">D: Byte サイズが格納される数値型データを選択してください (更新)</label>
  </config>
</configs>


<script><![CDATA[
//// == Config Retrieving / 工程コンフィグの参照 ==
const dataIdA = configs.get( "conf_DataIdA" ) + "";
const dataIdB = configs.get( "conf_DataIdB" ) + "";
const saveAs  = configs.get( "conf_SaveAs" ) + "";
const dataIdC = configs.get( "conf_DataIdC" ) + "";
const dataIdD = configs.get( "conf_DataIdD" ) + "";
// convert 'java.lang.String' to 'javascript string'


//// == Data Retrieving / ワークフローデータの参照 ==
let fileUrl = "";
if( engine.findDataDefinitionByNumber( dataIdA ).matchDataType( "SELECT_SINGLE" ) ){
    fileUrl = engine.findDataByNumber( dataIdA ).get(0).getValue() + "";
}else{
    fileUrl = engine.findDataByNumber( dataIdA ) + "";
}
if ( ! fileUrl.startsWith('http') ) {
  throw new Error( '\n Invalid URL. URL must start with either http or https. \n' );
}


let processFiles = engine.findDataByNumber( dataIdB );
// java.util.ArrayList <com.questetra.bpms.core.event.scripttask.QfileView>
if (processFiles === null) {
  processFiles = new java.util.ArrayList();
}


//// == Calculating / 演算 ==
/// File Name (from URI Path with Regular Expression)
let fileName = "";
if( saveAs === "" ){
  fileName = fileUrl.match(".+/(.+?)([\?#;].*)?$")[1];
  if( fileName.endsWith('/') ){ fileName = "NoName"; }
}else{
  fileName = saveAs;
}

/// Access to the URL
let httpRequest = httpClient.begin(); // HttpRequestWrapper
// com.questetra.bpms.core.event.scripttask.HttpClientWrapper
const response = httpRequest.get( fileUrl ); // HttpResponseWrapper
const httpStatus  = response.getStatusCode() + "";
engine.log( "STATUS: " + httpStatus );
const qfile = new com.questetra.bpms.core.event.scripttask.NewQfile(
    fileName, response.getContentType(), response.getResponse()
  );

/// Error Handling
// (no action)


//// == Data Updating / ワークフローデータへの代入 ==
processFiles.add( qfile );
engine.setDataByNumber( dataIdB, processFiles );

if( dataIdC !== "" ){
  engine.setDataByNumber( dataIdC, response.getContentType() );
}
if( dataIdD !== "" ){
  engine.setDataByNumber( dataIdD, new java.math.BigDecimal(qfile.getLength()) );
} // java.lang.Long -> java.math.BigDecimal

]]></script>


<icon>
iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADi0lEQVRYR8WXTUgUURzAf7NLq1GQ
Vhb0ZUGfErZZkIcoCSk6FCV0KXDdCmcPQXUp6rB+XCIttNNmJBYhQZfyEEEQbUXQIWEtsqAoKRSz
DruYGmZOvJlGd2ferLO51YNhF97//f+/997/6yn856FkZL+FfcB2NPwo5AH+3+tjaMRREL9RQnS4
1Ts1QBt5jHIcOAG6UTcjDjTj4xJBxH/HkR4gQhUemjIwbDUkjAdRueNE4AxwmWYUfefZGM2onJQp
kgO0cA0IZMPyhA6Na4QIWnXaAbK781R7GpcI6b40MVIBjDtvy+rO7cr2J/vEJIDh7R+m4XBuueP4
WGFGxyRAC7VAjZOWxi2NVK6upGBmgS7SM9hDY1cjke6IW8PJcnWouj2SAUTIzJFpa93eSmB1AK/i
TZkeGhuivrOehq6GTCHiqORPAhgZ7rZMy+6lu2kra2PhzIVSI33DfXwZ+cKy2cv4+O0jN97e4OKL
i26AdF8wTiCN54dLwpzdeJYcb44bpYyNj9H+rp2qaFV6+d8RYQC0ENVzvGTUb67ntP80Po/PFYAQ
+jzymWA0yL1P99KteYRKmQnQAxRapUsXlFK7uZYdi3YwwzMjZbp/uJ9zsXOULy5nT+GelLnR8VHO
x84Tfh5OBxBDZaMJoFkli/KKuFl+k+K5xVIlvUO9VD6s5ODKgxxZeyRFRkOjb6iPW+9vUfO8hsEf
g3IQFcURILI1QvW6ajyKJ2MAc4EAedD7gIr7FXKIJADbFXRWdFIyv0Rq/NnAM3be3Tmh9Iz/DOFN
YXK9uTb54bFh/SpskaHRRQi/oxO+OvCKovwiKcBP7Sftb9sJRAOIML2y7QpLZi1xvO/WN60cfXzU
Op/khJIw7NjVwd7CvY5KzSR0aNUhRz8Ri8e1cT1bHnt6LFWXJQxtiejwmsNcKL1Afo6esKRDxLzX
40VJSqhWwYGRAUJPQtzuseW5pERk5AJbKj614RTim5c7z3UOSBZMjCZoetlEXWeddX0C1WjvpixG
4m5FqK2fuz4jiK/fv3L19VW6492ydZJiZJRjEQ3SgpSR9fTCCXwst5djsei/NiQm9d9syWDi6E1z
/64pheuo2Erkv2rLbTtPfwLmrNGoiBb9Tx0zAVT92cPEhDCiQ7TS4nMLIgyLp1nz9J5m1nASJ6JR
hoIfjTwUNugiorAoxNGIoRBNt2Oryqkfp1lMADJVvwC8Hiswkyz4FwAAAABJRU5ErkJggg==
</icon>

</service-task-definition>
