<?xml version="1.0" encoding="UTF-8"?>
<service-task-definition>
    <last-modified>2022-06-27</last-modified>
    <license>(C) Questetra, Inc. (MIT License)</license>
    <engine-type>2</engine-type>
    <label>Stripe: Charge by Invoice</label>
    <label locale="ja">Stripe: 請求書で課金</label>

    <help-page-url>https://support.questetra.com/bpmn-icons/service-task-stripe-invoice-charge/</help-page-url>
    <help-page-url locale="ja">https://support.questetra.com/ja/bpmn-icons/service-task-stripe-invoice-charge/
    </help-page-url>

    <summary>This item charges the customer based on a finalized invoice on Stripe. If the default payment method
        fails, this item tries to charge other payment methods (card) attached to the customer.
        An error occurs if no charge succeeded.
    </summary>
    <summary locale="ja">この工程は、Stripe 上の確定済み請求書にもとづき、顧客に課金します。デフォルトの支払方法への課金が失敗した場合は、
        顧客に紐づけられている予備の支払方法（カード）に対して課金します。すべての課金に失敗した場合、エラーになります。
    </summary>

    <configs>
        <config name="conf_Auth" required="true" form-type="OAUTH2">
            <label>C1: Authorization Setting in which API Secret Key is set</label>
            <label locale="ja">C1: API シークレットキーを設定した認証設定</label>
        </config>
        <config name="conf_InvoiceId" required="true" form-type="SELECT" select-data-type="STRING_TEXTFIELD">
            <label>C2: Finalized Invoice ID</label>
            <label locale="ja">C2: 確定済み請求書の ID</label>
        </config>
        <config name="conf_ChargeId" required="false" form-type="SELECT" select-data-type="STRING_TEXTFIELD">
            <label>C3: Data item to save ID of the successful charge</label>
            <label locale="ja">C3: 成功した課金の ID を保存するデータ項目</label>
        </config>
        <config name="conf_ChargeUrl" required="false" form-type="SELECT" select-data-type="STRING_TEXTFIELD">
            <label>C4: Data item to save URL of the successful charge</label>
            <label locale="ja">C4: 成功した課金の URL を保存するデータ項目</label>
        </config>
    </configs>

    <script><![CDATA[// GraalJS Script (engine type: 2)

main();

function main(){
    //// == Config Retrieving / 工程コンフィグの参照 ==
    const auth = configs.get('conf_Auth');
    const invoiceId = retrieveInvoiceId();
    const chargeIdDef = configs.getObject('conf_ChargeId');
    const chargeUrlDef = configs.getObject('conf_ChargeUrl');

    //// == Calculating / 演算 ==
    const httpCounter = makeHttpCounter(); // HTTP リクエスト数のカウンタ
    const {customerId, invoiceDefaultPaymentMethodId} = checkInvoice(auth, invoiceId, httpCounter);
    const chargeId = chargeByInvoice(auth, invoiceId, customerId, invoiceDefaultPaymentMethodId, httpCounter);

    //// == Data Updating / ワークフローデータへの代入 ==
    if (chargeIdDef !== null) {
        engine.setData(chargeIdDef, chargeId);
    }
    if (chargeUrlDef !== null) {
        engine.setData(chargeUrlDef, `https://dashboard.stripe.com/payments/${chargeId}`);
    }
}

/**
  * config から請求書の ID を読み出す。空文字列の場合はエラー
  * @return {String} invoiceId 請求書の ID
  */
function retrieveInvoiceId() {
    const invoiceId = engine.findData(configs.getObject('conf_InvoiceId'));
    if (invoiceId === null) {
        throw 'Invoice ID is blank.';
    }
    return invoiceId;
}

/**
  * HTTP リクエスト数のカウンタを作成する
  * @return {Closure} httpCounter HTTP リクエスト数のカウンタ
  */
function makeHttpCounter() {
    let httpCount = 0;
    return {
        increment: function() {
            httpCount++;
        },
        value: function() {
            return httpCount;
        }
    }
};

/**
  * 請求書のステータスをチェックし、顧客 ID とデフォルトの支払方法の ID を返す
  * - ステータスが open, uncollectible 以外の場合はエラー
  * @param {String} oauth 認証設定
  * @param {String} invoiceId 請求書の ID
  * @param {Closure} httpCounter HTTP リクエスト数のカウンタ
  * @return {Object} returnObj
  * @return {String} returnObj.customerId 顧客 ID
  * @return {String} returnObj.invoiceDefaultPaymentMethodId デフォルトの支払方法の ID
  */
function checkInvoice(auth, invoiceId, httpCounter) {
    const apiUri = `https://api.stripe.com/v1/invoices/${encodeURIComponent(invoiceId)}`;
    const response = httpClient.begin()
        .authSetting(auth) // with "Authorization: Bearer XX"
        .get(apiUri);
    httpCounter.increment();
    const status = response.getStatusCode();
    const responseStr = response.getResponseAsString();
    if (status !== 200) { // 削除済みの場合もエラーレスポンス
        engine.log(responseStr);
        throw `Failed to retrieve invoice. status: ${status}`;
    }
    const invoiceObj = JSON.parse(responseStr);
    switch (invoiceObj.status) {
        case 'draft':
            throw 'The invoice is still draft. It needs to be finalized first.';
        case 'paid':
            throw 'The invoice is already paid.';
        case 'void':
            throw 'The invoice is void.';
        default: // open or uncollectible
            // do nothing
    }
    const customerId = invoiceObj.customer;
    const invoiceDefaultPaymentMethodId = invoiceObj.default_payment_method;
    return {customerId, invoiceDefaultPaymentMethodId};
}

/**
  * 請求書で課金する。課金を試みる支払方法の順序は
  * 1. 請求書のデフォルトの支払方法
  * 2. 顧客のデフォルトの支払方法
  * 3. 顧客の予備の支払方法（カード）
  * @param {String} oauth 認証設定
  * @param {String} invoiceId 請求書の ID
  * @param {String} customerId 顧客 ID
  * @param {String} invoiceDefaultPaymentMethodId 請求書のデフォルトの支払方法の ID
  * @param {Closure} httpCounter HTTP リクエスト数のカウンタ
  * @return {String} chargeId 課金オブジェクトの ID
  */
function chargeByInvoice(auth, invoiceId, customerId, invoiceDefaultPaymentMethodId, httpCounter) {
    let chargeId = null;
    if (invoiceDefaultPaymentMethodId !== null) {
        chargeId = tryCharge(auth, invoiceId, invoiceDefaultPaymentMethodId, httpCounter);
    }
    if (chargeId !== null) {
        return chargeId;
    }
    const customerDefaultPaymentMethodId = getDefaultPaymentMethodId(auth, customerId, httpCounter);
    if (customerDefaultPaymentMethodId !== null && customerDefaultPaymentMethodId !== invoiceDefaultPaymentMethodId) {
        chargeId = tryCharge(auth, invoiceId, customerDefaultPaymentMethodId, httpCounter);
    }
    if (chargeId !== null) {
        return chargeId;
    }
    const customerPaymentMethodIds = getCustomerPaymentMethodIds(auth, customerId, httpCounter);
    const otherPaymentMethodIds = customerPaymentMethodIds
        .filter(id => id !== invoiceDefaultPaymentMethodId && id !== customerDefaultPaymentMethodId);
    const httpLimit = httpClient.getRequestingLimit();
    for (let i = 0; i < otherPaymentMethodIds.length; i++) {
        if (httpCounter.value() >= httpLimit) {
            throw `Number of HTTP requests exceeds the limit.`;
        }
        chargeId = tryCharge(auth, invoiceId, otherPaymentMethodIds[i], httpCounter);
        if (chargeId !== null) {
            return chargeId;
        }
    }
    throw 'No payment method succeeded.';
}

/**
  * 指定した支払方法への課金を試みる
  * @param {String} oauth 認証設定
  * @param {String} invoiceId 請求書の ID
  * @param {String} paymentMethodId 支払方法の ID
  * @param {Closure} httpCounter HTTP リクエスト数のカウンタ
  * @return {String} chargeId 課金オブジェクトの ID。課金に失敗した場合は null
  */
function tryCharge(auth, invoiceId, paymentMethodId, httpCounter) {
    const apiUri = `https://api.stripe.com/v1/invoices/${encodeURIComponent(invoiceId)}/pay`;
    const response = httpClient.begin()
        .authSetting(auth) // with "Authorization: Bearer XX"
        .formParam('payment_method', paymentMethodId)
        .post(apiUri);
    httpCounter.increment();
    const status = response.getStatusCode();
    const responseStr = response.getResponseAsString();
    if (status !== 200) {
        let errorLog = `Failed to charge by the payment method: ${paymentMethodId}, status: ${status}`;
        const error = JSON.parse(responseStr).error;
        if (error !== undefined && error.message !== undefined) {
            errorLog += `, message: ${error.message}`;
        }
        engine.log(errorLog);
        return null;
    }
    const invoiceObj = JSON.parse(responseStr);
    return invoiceObj.charge;
}

/**
  * 顧客情報を取得する GET リクエストを送信し、デフォルトの支払方法の ID を取得する
  * @param {String} oauth 認証設定
  * @param {String} customerId 顧客 ID
  * @param {Closure} httpCounter HTTP リクエスト数のカウンタ
  * @return {String} defaultPaymentMethodId デフォルトの支払方法の ID
  */
function getDefaultPaymentMethodId(auth, customerId, httpCounter) {
    const apiUri = `https://api.stripe.com/v1/customers/${customerId}`;
    const response = httpClient.begin()
            .authSetting(auth) // with "Authorization: Bearer XX"
            .get(apiUri);
    httpCounter.increment();
    const status = response.getStatusCode();
    const responseStr = response.getResponseAsString();
    if (status !== 200) {
        engine.log(responseStr);
        throw `Failed to get customer. status: ${status}`;
    }
    const responseObj = JSON.parse(responseStr);
    if (responseObj.deleted) { // 削除済みの顧客の場合
        throw 'The customer is deleted.';
    }
    let defaultPaymentMethodId = responseObj.invoice_settings.default_payment_method;
    if (defaultPaymentMethodId === null) {
        // Source として登録されている場合もある
        defaultPaymentMethodId = responseObj.default_source;
    }
    return defaultPaymentMethodId;
}

/**
  * 顧客の支払方法（カード）の ID 一覧を取得する
  * @param {String} oauth 認証設定
  * @param {String} customerId 顧客 ID
  * @param {Closure} httpCounter HTTP リクエスト数のカウンタ
  * @return {Array<String>} paymentMethodIds 支払方法（カード）の ID 一覧
  */
function getCustomerPaymentMethodIds(auth, customerId, httpCounter) {
    const apiUri = `https://api.stripe.com/v1/customers/${customerId}/payment_methods`;
    const response = httpClient.begin()
        .authSetting(auth) // with "Authorization: Bearer XX"
        .queryParam('type', 'card') // required
        .queryParam('limit', '100') // maximum limit
        .get(apiUri);
    httpCounter.increment();
    const status = response.getStatusCode();
    const responseStr = response.getResponseAsString();
    if (status !== 200) {
        engine.log(responseStr);
        throw `Failed to get the customer's payment methods. status: ${status}`;
    }
    const responseObj = JSON.parse(responseStr);
    const paymentMethods = responseObj.data;
    if (paymentMethods.length === 0) {
        throw 'The customer has no card-type payment methods.';
    }
    return paymentMethods.map(paymentMethod => paymentMethod.id);
}

    ]]></script>

    <icon>
        iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADaUlEQVRYR8WXSUwTYRTH/x9bS8tS
        KCWIbLFElkgiICQdw2I0xujB6MGo0cRojOBJEy0HLyQmJlQDnoSLXDQYLibGNUoili0sAoKGICAE
        LLKWRVpKW+YzHWiBtpQpYGau897//ea9973vDYHAD+EbP7O4TSKRLp0llBwBRToIEgCErfrPgGII
        BB2U0M9Gg+jl1+JDRj7aWwLka1qiWGotAkEBADEfUQAmUFT4EL+SWnX2mCcfjwA5JU0FhNBHAKQ8
        AzubGSgld+qKVBWb+W8KkKdpekJBC7cZeIMbASn/olbddKflFiBH01hFgAu7EdyuQYEXdWrmorOm
        C8BufrlrMNdMbABYrXn5bn65sxalpHB9TzgAuG6HtX8HDceX2+ADv0T76XAA5JY0loHgFl+VHdlR
        PNYWMbdtGhyAbchIJeZpL875juLb5oTBGCC3DSsOIOdhwyVCyTNvVRXBAYgKEaFb99dbV1BCL9fd
        PfycA8jVND4FcNWTSt5+OaQiX7zrnnCY3T+dhMz4UJR++oWanilvISq1aubaCkBJYzsI0p0VVPvC
        IAnwhb8fwY3ceOhmTahq1sHf1weWZRaRISLEhYtR3zeDYLEfDGYrWBZoH55DgjwQSoUUA5MGDE0v
        usJRdGiLmAx7BvTrLhbO+N6pRBxLicCihcX0ghmx4YEwmZfRN2FAWkwILFYWUwtmyCT+6ByZh0oZ
        BpalsCxTvP8+gaMpEfAhgMnCQvNhAM2Ds84QM1o1E24HoM5vH5xJhkop48Tr+vS4nhOHnj8LGJtf
        wvFUBapbR5EaHYTkqCDOJitBhtahWWQlhGJYb0K8PBDD04uIlolR3TaKyvoRlyxo1QzZFCAjLhTn
        s6M5wYb+Ga7WvWMLGJ1bAahq0eFAdDBS9qwBdI7M4WBsKAanjFAqJOj6PQ+90QLtTz1qe22HbOOz
        HsClBKXnUrmgS1YWr7+NIz9JjoigAK6ee2ViFwBGubIazC9a8aZrHCfTIrnyGM3LKKsZxMcfkx5K
        sEkT8m1r9QmlIyvuUu1Wx6kJtzyGnmCuMDFgEsPxtmscrzrH+XKvHcPtDiK+kdzZbRhEgo/i1WEk
        3GVkAxD8OuYupZUlVJiFxN4ogq5kdghBl9L/kQmv13JHJoT8MbFDCPprtn6CCfZzupNxy8f3Hyxn
        oTBfuPFrAAAAAElFTkSuQmCC
    </icon>

</service-task-definition>
