<?xml version="1.0" encoding="UTF-8"?>
<service-task-definition>
    <last-modified>2023-08-28</last-modified>
    <license>(C) Questetra, Inc. (MIT License)</license>
    <engine-type>3</engine-type>
    <label>Box: Cancel Sign Request</label>
    <label locale="ja">Box Sign: 署名リクエストキャンセル</label>
    <summary>This item cancels a sign request of the specified signing document on Box.
    </summary>
    <summary locale="ja">この工程は、Box 上の指定の署名リクエストをキャンセルします。</summary>
    <help-page-url>https://support.questetra.com/bpmn-icons/service-task-box-sign-request-cancel/</help-page-url>
    <help-page-url locale="ja">https://support.questetra.com/ja/bpmn-icons/service-task-box-sign-request-cancel/
    </help-page-url>
    <configs>
        <config name="conf_OAuth2" required="true" form-type="OAUTH2" auth-type="OAUTH2"
                oauth2-setting-name="https://app.box.com/api/oauth2/sign_requests.readwrite">
            <label>C1: OAuth2 Setting</label>
            <label locale="ja">C1: OAuth2 設定</label>
        </config>
        <config name="conf_RequestId" required="true" form-type="SELECT" select-data-type="STRING_TEXTFIELD">
            <label>C2: Sign Request ID</label>
            <label locale="ja">C2: 署名リクエスト ID</label>
        </config>
    </configs>

    <script><![CDATA[
main();
function main() {
    const oauth2 = configs.get("conf_OAuth2");
    const requestId = decideRequestId();
    checkStatus(oauth2, requestId);
}

/**
 * リクエストIDをconfigから読み出して出力する。
 * @return {String} requestId リクエスト ID
 */
function decideRequestId() {
    const requestIdDef = configs.getObject("conf_RequestId");
    requestId = engine.findData(requestIdDef);
    if (requestId === null) {
        throw "Request ID is blank";
    }
    return requestId;
}

/**
 * 署名リクエストのステータスを確認後、署名リクエストをキャンセルする
 * 全員署名済、拒否、キャンセル済の場合は正常終了
 * 変換中の場合はエラーにする
 * @param {String} oauth OAuth2 設定
 * @param {String} requestId 署名リクエストの ID
 */
function checkStatus(oauth2, requestId) {
    const signRequest = getSignRequest(oauth2, requestId);
    const status = signRequest.status;
    if (status === 'signed') {
        engine.log('Request signed.');
        return;
    } else if (status === 'declined') {
        engine.log('Request declined.');
        return;
    } else if (status === 'cancelled') {
        engine.log('Request has already cancelled.');
        return;
    } else if (status === 'converting') {
        throw `Failed to Cancel. Request converting.`;
    } else {
        cancelRequest(oauth2, requestId);
    }
}

/**
  * 署名リクエストを取得
  * @param {String} oauth2 OAuth2 設定
  * @param {String} requestId 署名リクエストの ID
  * @return {Object} signRequest 署名リクエスト
  */
function getSignRequest(oauth2, requestId) {
    const url = `https://api.box.com/2.0/sign_requests/${requestId}`;
    const response = httpClient.begin()
        .authSetting(oauth2)
        .get(url);
    const status = response.getStatusCode();
    const responseTxt = response.getResponseAsString();
    if (status !== 200) {
        engine.log(responseTxt);
        throw `Failed to get Sign Request. status: ${status}`;
    }
    return JSON.parse(responseTxt);
}

/**
 * 署名リクエストキャンセル
 * @param {String} oauth2 OAuth2 設定
 * @param {String} requestId 署名リクエストの ID
 */
function cancelRequest(oauth2, requestId) {
    const url = `https://api.box.com/2.0/sign_requests/${requestId}/cancel`;
    const response = httpClient.begin()
        .authSetting(oauth2)
        .post(url);
    const status = response.getStatusCode();
    const responseTxt = response.getResponseAsString();
    if (status !== 200) {
        const error = `Failed to cancel. status: ${status}`;
        engine.log(responseTxt);
        throw error;
    }
    engine.log(`status: ${status} Request was cancelled, request ID: ${requestId}`);
}
]]></script>

    <icon>iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEBElEQVRYR82Xb2jbRRjHP/fL2jXJ
        0qSd65x11aK0YgJWZUwEWZ0DfSNaHYKKmgykbP7pH/SVghvCkIlb6kREwfyGOougbgxB2Yt1oGwg
        aietdOJoV21ty2ob26xdm+TkLsufJr+2Sdtt3pv8uDx3z+ee+z53zwmucRMF+ff/9ijEtwB1IDwI
        9QtIOkGOA50I0UHIezTfeRcH8Pd64GITyGaE8OQ1sVQwIgiONsxqBTZvWxjA3+UHDuTtONuNBjEC
        mLcfmY9gfgB/dxBBU14rXsxIyiCmr8XKzBog0GWCeG6xeQv6X2JiegPZY3IBVnLlOVtCG6a3ObN7
        LoDacyFCBa2sUGMpGjI1kQbQao/0Lllw+YJoYTqrk9mRAdC9G8Eb+c6zLDvJHkzvbjVHGiDQpXLX
        nZw4tOMGyp02Hjn457J8WQ5WUTB9ZWkAdcIJ+XWm8XCwFkexwLWrZ+UB9OmZ0EIiAhbKH2lLAKzZ
        eaUAEhmRAAh0dYBQZ3yqKQDnaoPDp8PUVZXo/pM9EV75Ylh/77q/jO2bSlmz2mBgLErjoUHad95I
        Z/80re0Jmw+e3UD1dcU8uP+8RRTlSUK++ssA3X3ATdkA61y2nIE/9k7Rd2GWx+4uxWZkAP8bo9Ru
        YAho+XyIUruNNxsqiMzE8bxgEUV1gZneO5MAMtuTioACUM7e+W4Uj8Pg5W1rdV9cwvSsxPx+nNPn
        LvLStnI2VdsZi8TwOGyMTsY0nNth493j/9DSPmSto5BXLAigsmDLW7388MeUnuDVh9ay74n1+vvI
        zxM0vJfOkNGDtdiLDH7pn+beW+3a5kRPhK37rMJ/mScDIGcLBvfXsM61isrWs4xMxPSIpza7+ayx
        Un8rbTz94UBqZX8fqNFp+82vkzTc5dL9n54K88xHaZu5YZBnCPnq5hXhqdequecWO2rPH3j7PBvc
        qzjWVEXN9cV6HhVmJbwvf5rgcGMlT2526y1wldiYiUl9wKhtUHp4/8TYIiK0SMP6WgdfvbiRMqeN
        yKU4NkNQUiToH51lcDyq4aIxtMjcdoOpGYkSkrJpOz6qt6OxvowLkzEqms7mAsjMNLQ4iNSIrbc5
        2bu9QqdSNC7pHrjEjo8H+GssyifPV3JfjQNHscFQOMqeoyPsfXw9vw/P8HBbv3b4bWsVG8uL8L5+
        zgIg8yBSf2cdxdayXaleGSbk0+Xd/+gyUtexiPRlXkgrtd4s9YeRzptzr2NldU0LkiTmlS3JUnVA
        0t3VK0qRhwj5VJk/p12lsjxdAeUPoDWhCpW4KtFTlVJhwpRhpOFf2sMkpQn9NGtGyOb8QZRj/TQL
        Lu9plr1c/TiV9QipHqUeEHckTOQZYBwpOkF0LLTiwragsHgvyfo/g3CBMFgjn40AAAAASUVORK5C
        YII=
    </icon>

    <test><![CDATA[

/**
 * 設定の準備
 * requestId は、文字型データ項目で指定
 * @param requestId
 * @return {Object}
 */
const prepareConfigs = (requestId) => {
    configs.put("conf_OAuth2", "Box");
    const requestIdDef = engine.createDataDefinition(
        "リクエスト ID",
        3,
        "q_requestId",
        "STRING_TEXTFIELD"
    );
    configs.putObject("conf_RequestId", requestIdDef);
    engine.setData(requestIdDef, requestId);

    return requestIdDef;
};

/**
 * リクエスト ID を指定し、値が空
 */
test("No Request ID", () => {
    prepareConfigs(null);
    expect(execute).toThrow("Request ID is blank");
});


/**
 * GET リクエストのレスポンスを準備
 * @param id
 * @param status
 * @return responseObj
 */
const prepareGetResponse = (id, status) => {

    const responseObj = {
        id,
        status,
    };
    return responseObj;
};

/**
 * GET リクエスト のテスト
 * @param url
 * @param method
 * @param requestId
 */
const assertGetRequest = ({ url, method }, requestId) => {
    expect(url).toEqual(`https://api.box.com/2.0/sign_requests/${requestId}`);
    expect(method).toEqual('GET');
};

/**
 * GET リクエストで失敗
 */
test("GET Failed", () => {
    prepareConfigs("12345");

    httpClient.setRequestHandler((request) => {
        assertGetRequest(request, "12345");
        return httpClient.createHttpResponse(400, "application/json", "{}");
    });

    expect(execute).toThrow("Failed to get Sign Request. status: 400");
});


/**
 * Post リクエスト のテスト
 * @param url
 * @param method
 * @param requestId
 */
const assertPostRequest = ({ url, method }, requestId) => {
    expect(url).toEqual(`https://api.box.com/2.0/sign_requests/${requestId}/cancel`);
    expect(method).toEqual('POST');
};


/**
 * POST リクエストで失敗
 */
test("POST Failed", () => {
    prepareConfigs("12345");

    let reqCount = 0;
    httpClient.setRequestHandler((request) => {
        if (reqCount === 0) {
            assertGetRequest(request, "12345");
            reqCount++;
            return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("12345", "sent")));
        }
        assertPostRequest(request, "12345");
        return httpClient.createHttpResponse(400, "application/json", "{}");
    });

    expect(execute).toThrow("Failed to cancel. status: 400");
});


/**
 * 正常系 ステータスは sent
 */
test("Success - sent", () => {
    const requestIdDef = prepareConfigs("00000");

    let reqCount = 0;
    httpClient.setRequestHandler((request) => {
        if (reqCount === 0) {
            assertGetRequest(request, "00000");
            reqCount++;
            return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("00000", "sent")));
        }
        assertPostRequest(request, "00000");
        return httpClient.createHttpResponse(200, "application/json", "{}");
    });
    execute();
    expect(engine.findData(requestIdDef)).toEqual("00000");
});

/**
 * 正常系 ステータスは viewed
 */
test("Success - viewed", () => {
    const requestIdDef = prepareConfigs("23456");

    let reqCount = 0;
    httpClient.setRequestHandler((request) => {
        if (reqCount === 0) {
            assertGetRequest(request, "23456");
            reqCount++;
            return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("23456", "viewed")));
        }
        assertPostRequest(request, "23456");
        return httpClient.createHttpResponse(200, "application/json", "{}");
    });
    execute();
    expect(engine.findData(requestIdDef)).toEqual('23456');
});


/**
 * 異常系 ステータスは converting
 */
test("Failed - converting", () => {
    const requestIdDef = prepareConfigs("34567");

    httpClient.setRequestHandler((request) => {
        assertGetRequest(request, "34567");
        return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("34567", "converting")));
    });
    expect(execute).toThrow("Failed to Cancel. Request converting.");
});

/**
 * 正常系 ステータスは declined キャンセル処理せずに正常終了
 */
test("Success - declined", () => {
    const requestIdDef = prepareConfigs("45678");

    httpClient.setRequestHandler((request) => {
        assertGetRequest(request, "45678");
        return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("45678", "declined")));
    });
    execute();
});

/**
 * 正常系 ステータスは signed キャンセル処理せずに正常終了
 */
test("Success - signed", () => {
    const requestIdDef = prepareConfigs("56789");

    httpClient.setRequestHandler((request) => {
        assertGetRequest(request, "56789");
        return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("56789", "signed")));
    });
    execute();
});

/**
 * 正常系 ステータスは cancelled キャンセル処理せずに正常終了
 */
test("Success - cancelled", () => {
    const requestIdDef = prepareConfigs("67890");

    httpClient.setRequestHandler((request) => {
        assertGetRequest(request, "67890");
        return httpClient.createHttpResponse(200, 'application/json', JSON.stringify(prepareGetResponse("67890", "cancelled")));
    });
    execute();
});


]]></test>

</service-task-definition>
